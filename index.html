<!DOCTYPE HTML>
<html lang="en-US">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <title>Hello My Dear!</title>
    <style type="text/css">
        body,
        div,
        dl,
        dt,
        dd,
        ul,
        ol,
        li,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        pre,
        form,
        fieldset,
        input,
        textarea,
        p,
        blockquote,
        th,
        td {
            margin: 0;
            padding: 0;
        }

        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        fieldset,
        img {
            border: 0;
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        strong,
        th,
        var {
            font-style: normal;
            font-weight: normal;
        }

        ol,
        ul {
            list-style: none;
        }

        caption,
        th {
            text-align: left;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-size: 100%;
            font-weight: bold;
        }

        q:before,
        q:after {
            content: '';
        }

        abbr,
        acronym {
            border: 0;
        }

        body,
        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* Common 定义基本样式 */
        body {
            font: 12px/1.8 'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, Sans-serif;
            padding: 0;
            margin: 0;
            color: #333333;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        #loading {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 999;
            background: url("./images/site/loading.gif") no-repeat center center #FFFAD1;
            top: 0;
            left: 0;
            text-align: center;
            line-height: 300px;
            font-size: 32px;
            color: #666;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        #startButton {
            display: inline-block;
            padding: 15px 30px;
            font-size: 24px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            -webkit-tap-highlight-color: transparent;
        }

        #startButton:active {
            background: #ff5252;
            transform: scale(0.98);
        }

        #theEnd {
            height: 0%;
            width: 100%;
            line-height: 0;
            font-size: 0;
            overflow: hidden;
            position: absolute;
            z-index: 999;
            background-color: #FFFAD1;
            top: 0;
            left: 0;
        }

        #theEndText {
            position: absolute;
            left: 0;
            z-index: 9999;
            width: 100%;
            text-align: center;
            font-size: 26px;
            line-height: 2;
            top: 50%;
            margin-top: -100px;
            height: 200px;
        }

        #theEndText button {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        #theEndText button:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div id="loading">正在加载...</div>
    <div id="theEnd"></div>
    <div id="map"></div>

    <!-- 指定全局的分享内容 -->
    <input id="wsContent" type="hidden" value="">
    <!-- 指定全局的分享链接 -->
    <input id="wsUrl" type="hidden" value="">
    <!-- 指定全局的分享图片 -->
    <input id="wsPic" type="hidden" value="./social.png">

    <script type="text/javascript" src="./config.js"></script>
    <script type="text/javascript" src="./jquery.min.js"></script>
    <script type="text/javascript" src="./jquery.wshare.js"></script>
    <script type="text/javascript" src="./sm/soundmanager2-nodebug-jsmin.js"></script>
    <script type="text/javascript">
        (function (a, b) { "use strict"; var c = function () { var a = [["requestFullscreen", "exitFullscreen", "fullscreenchange", "fullscreen", "fullscreenElement"], ["webkitRequestFullScreen", "webkitCancelFullScreen", "webkitfullscreenchange", "webkitIsFullScreen", "webkitCurrentFullScreenElement"], ["mozRequestFullScreen", "mozCancelFullScreen", "mozfullscreenchange", "mozFullScreen", "mozFullScreenElement"]]; for (var c = 0, d = a.length; c < d; c++) { var e = a[c]; if (e[1] in b) return e } }(); if (!c) return a.screenfull = !1; var d = "ALLOW_KEYBOARD_INPUT" in Element, e = { init: function () { return b.addEventListener(c[2], function (a) { e.isFullscreen = b[c[3]], e.element = b[c[4]], e.onchange(a) }), this }, isFullscreen: b[c[3]], element: b[c[4]], request: function (a) { a = a || b.documentElement, a[c[0]](d && Element.ALLOW_KEYBOARD_INPUT), b.isFullscreen || a[c[0]]() }, exit: function () { b[c[1]]() }, toggle: function (a) { this.isFullscreen ? this.exit() : this.request(a) }, onchange: function () { } }; a.screenfull = e.init() })(window, document)
    </script>
    <script type="text/javascript">
        let COORDS = null;
        let LOCATIONS = null;
        let ROUTE_INFO = null;
        let PHOTOS = null;
        let WANNATO = null;
        let MARKER_TEXT = null;
        let AUDIO = null;
        let IMAGES = null;
        let TEXT = null;
        let ANIMATION = null;
        let SHARE = null;

        // 背景音乐
        let MUSIC;

        // 检测移动设备
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // 工具函数：地图缩放动画
        const zoomTo = (zoom, time = 1000, callback = () => { }, point = null) => {
            let loop;
            const loopZoom = () => {
                const curZoom = map.getZoom();
                if (curZoom === zoom) {
                    clearTimeout(loop);
                    callback();
                    return false;
                }
                const plus = curZoom > zoom ? -1 : 1;
                const toZoom = curZoom + plus;
                map.setZoom(toZoom);
                if (point) {
                    map.setCenter(point);
                }
                loop = setTimeout(loopZoom, time);
            };
            loopZoom();
        };

        // 工具函数：信息窗口轮播
        const loopWin = (loopList, time = 2000, callback = () => { }) => {
            let i = 0;
            const len = loopList.length;
            let timeout;

            const loopWinInner = () => {
                if (i === len) {
                    clearTimeout(timeout);
                    setTimeout(callback, 1000);
                    return false;
                }

                // 根据contentType处理内容
                let content = loopList[i].content;
                if (loopList[i].contentType === 'image') {
                    // 移动端使用响应式图片尺寸
                    const maxWidth = isMobile ? '90vw' : '600px';
                    const minWidth = isMobile ? '80vw' : '400px';
                    content = `<img src="${content}" style="width: 100%; max-width: ${maxWidth}; min-width: ${minWidth}; height: auto;" alt="${loopList[i].title || 'Image'}" />`;
                }

                const opts = {
                    title: loopList[i].title,
                    maxWidth: isMobile ? 300 : 600,
                    height: 0
                };
                const infoWindow = new BMap.InfoWindow(content, opts);
                map.openInfoWindow(infoWindow, new BMap.Point(loopList[i].point.lng, loopList[i].point.lat));
                infoWindow.redraw();
                i++;
                const nextTime = loopList[i]?.timeout || time;
                timeout = setTimeout(loopWinInner, nextTime);
            };

            loopWinInner();
        };

        // 工具函数：添加标记
        const addMarker = (lng, lat) => {
            const marker = new BMap.Marker(new BMap.Point(lng, lat));
            marker.setAnimation(BMAP_ANIMATION_DROP);
            map.addOverlay(marker);
        };

        // 工具函数：添加弹跳标记
        const addBouncingMarker = (coords) => {
            const marker = new BMap.Marker(coords);
            map.addOverlay(marker);
            marker.setAnimation(BMAP_ANIMATION_BOUNCE);
        };

        // 工具函数：下滑动画
        const slideDown = (id, speed = 1000, callback = () => { }) => {
            const object = document.getElementById(id);
            const timeout = speed * 0.001;
            let loop;
            object.style.display = 'block';
            object.style.height = '0%';

            const slideDownInner = () => {
                const curHeight = parseFloat(object.style.height) || 0;
                if (curHeight >= 100) {
                    clearTimeout(loop);
                    callback();
                    return false;
                }
                object.style.height = (curHeight + 0.1) + '%';
                loop = setTimeout(slideDownInner, timeout);
            };

            slideDownInner();
        };

        // 工具函数：预加载图片（优化版）
        const preLoadImages = (imagesList, callback = () => { }) => {
            const len = imagesList.length;
            let i = 0;
            const images = {};
            let loadedCount = 0;

            const onImageLoad = () => {
                loadedCount++;
                if (loadedCount === len) {
                    callback();
                }
            };

            const loadImage = () => {
                if (i === len) {
                    return false;
                }
                images[i] = new Image();
                images[i].onload = onImageLoad;
                images[i].onerror = onImageLoad; // 即使加载失败也继续
                images[i].src = imagesList[i];
                i++;
                loadImage();
            };

            if (len === 0) {
                callback();
            } else {
                loadImage();
            }
        };

        // 工具函数：数组随机排序
        if (!Array.prototype.shuffle) {
            Array.prototype.shuffle = function () {
                for (let j, x, i = this.length; i; j = parseInt(Math.random() * i), x = this[--i], this[i] = this[j], this[j] = x);
                return this;
            };
        }

        // 展示女方位置
        const showGirlLocation = () => {
            const { coords } = LOCATIONS.GIRL;
            map.panTo(new BMap.Point(coords.lng, coords.lat));
            setTimeout(() => {
                zoomTo(18, ANIMATION.ZOOM_SPEED, () => {
                    addBouncingMarker(coords);
                    setTimeout(showBoyLocation, 1000);
                }, coords);
            }, ANIMATION.PAN_DELAY);
        };

        // 展示男方位置
        const showBoyLocation = () => {
            zoomTo(8, 1000, () => {
                const { coords } = LOCATIONS.BOY;
                map.panTo(new BMap.Point(coords.lng, coords.lat));
                setTimeout(() => {
                    zoomTo(16, ANIMATION.ZOOM_SPEED, () => {
                        addBouncingMarker(coords);
                        setTimeout(showMiddleCity, 1000);
                    });
                }, 1000);
            });
        };

        // 展示中间城市和路线信息
        const showMiddleCity = () => {
            zoomTo(9, 1000, () => {
                const { coords } = LOCATIONS.MIDDLE;
                map.panTo(new BMap.Point(coords.lng, coords.lat));
                setTimeout(() => {
                    // 绘制路线
                    const start = new BMap.Point(LOCATIONS.BOY.coords.lng, LOCATIONS.BOY.coords.lat);
                    const end = new BMap.Point(LOCATIONS.GIRL.coords.lng, LOCATIONS.GIRL.coords.lat);
                    const driving2 = new BMap.DrivingRoute(map, { renderOptions: { map: map, autoViewport: false } });
                    driving2.search(start, end);

                    // 显示路线信息
                    setTimeout(() => {
                        loopWin(ROUTE_INFO, 2000, showPhotos);
                    }, 2000);
                }, 1000);
            });
        };

        // 展示共同经历的照片
        const showPhotos = () => {
            map.clearOverlays();
            const { coords } = LOCATIONS.PHOTO_START_LOC;
            map.panTo(new BMap.Point(coords.lng, coords.lat));
            setTimeout(() => {
                zoomTo(13, 1000, () => {
                    loopWin(PHOTOS, 2500, showWannaGoPlaces);
                });
            }, 1000);
        };

        // 展示想去的地方
        const showWannaGoPlaces = () => {
            map.closeInfoWindow();
            zoomTo(5, 1000, () => {
                map.panTo(new BMap.Point(COORDS.WANT_TO_CN_CEN.lng, COORDS.WANT_TO_CN_CEN.lat));
                map.setMapType(BMAP_HYBRID_MAP);
                setTimeout(() => {
                    loopWin(WANNATO, 1000, showMarkerAnimation);
                }, 1000);
            });
        };

        // 展示标记点动画
        const showMarkerAnimation = () => {
            map.closeInfoWindow();
            map.panTo(new BMap.Point(82.699584, 39.8202));
            setTimeout(() => {
                zoomTo(9, 1000, () => {
                    const shuffledMarkers = [...MARKER_TEXT].shuffle();
                    let i = 0;
                    const len = shuffledMarkers.length;
                    let loop;

                    const loopAddMarker = () => {
                        if (i === len) {
                            clearTimeout(loop);
                            setTimeout(showEndScreen, 5000);
                            return false;
                        }
                        const marker = shuffledMarkers[i];
                        addMarker(marker.lng, marker.lat);
                        i++;
                        loop = setTimeout(loopAddMarker, ANIMATION.MARKER_INTERVAL);
                    };

                    loopAddMarker();
                });
            }, 1000);
        };

        // 显示结束画面
        const showEndScreen = () => {
            slideDown('theEnd', 1000, () => {
                const theEndText = `
                    <div id="theEndText">
                        ${TEXT.BIRTHDAY_WISH}<br />
                        <button data-toggle="wshare" data-type="weibo">${TEXT.SHARE_WEIBO}</button>
                        <button onclick="window.location.reload();">${TEXT.WATCH_AGAIN}</button>
                        <button onclick="window.location.href='./config-manager.html';">修改配置</button>
                    </div>
                `;
                document.getElementById('theEnd').innerHTML = theEndText;
            });
        };

        let map;

        // 初始化地图-全屏地图展示开始入口函数
        const initMap = () => {
            try {
                map = new BMap.Map("map");
                const point = new BMap.Point(COORDS.INIT_MP_CEN.lng, COORDS.INIT_MP_CEN.lat);
                map.centerAndZoom(point, 4);
                map.disableDragging();
                map.disableDoubleClickZoom();
                init();
            } catch (error) {
                console.error('地图初始化失败:', error);
                alert('地图加载失败，请刷新页面重试');
            }
        };

        // 初始化应用
        const init = () => {
            document.getElementById('wsContent').value = SHARE.CONTENT;
            document.getElementById('wsUrl').value = SHARE.URL;
            document.getElementById('wsPic').value = SHARE.PIC;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('theEnd').style.height = '0';
            document.getElementById('theEnd').innerHTML = '';
            map.setMapType(BMAP_NORMAL_MAP);
            const point = new BMap.Point(COORDS.INIT_MP_CEN.lng, COORDS.INIT_MP_CEN.lat);
            map.centerAndZoom(point, 4);
            map.clearOverlays();
            map.reset();

            // 播放音乐（在用户交互后调用）
            try {
                if (MUSIC) {
                    // 更新播放状态
                    MUSIC.playState = 1;
                    MUSIC.paused = false;
                    MUSIC.play();
                    console.log('开始播放音乐');
                }
            } catch (error) {
                console.error('音乐播放失败:', error);
            }

            // 开始展示
            const { coords } = LOCATIONS.GIRL;
            map.panTo(new BMap.Point(coords.lng, coords.lat));
            showGirlLocation();
        };

        // 加载百度地图脚本
        const loadScript = () => {
            const script = document.createElement("script");
            script.src = "https://api.map.baidu.com/api?v=3.0&ak=EXl1klVct9z0GXE7KAkPUkawwDhDN0h9&callback=initMap";
            script.onerror = () => {
                alert('百度地图API加载失败，请检查网络连接');
            };
            document.body.appendChild(script);
        };

        // 开始按钮点击事件
        const handleStartClick = () => {
            // 尝试全屏
            try {
                if (screenfull && screenfull.request) {
                    screenfull.request();
                }
            } catch (error) {
                console.log('全屏请求失败:', error);
            }

            // 加载地图
            loadScript();
        };

        // 页面加载完成后初始化
        window.onload = () => {
            const initMP3 = () => {
                window.ConfigManager.getConfig().then(config => {
                    COORDS = config.COORDS;
                    LOCATIONS = config.LOCATIONS;
                    ROUTE_INFO = config.ROUTE_INFO;
                    PHOTOS = config.PHOTOS;
                    WANNATO = config.WANNATO;
                    MARKER_TEXT = config.MARKER_TEXT;
                    AUDIO = config.AUDIO;
                    IMAGES = config.IMAGES;
                    TEXT = config.TEXT;
                    ANIMATION = config.ANIMATION;
                    SHARE = config.SHARE;

                    // 创建音乐对象
                    MUSIC = soundManager.createSound({
                        id: 'mp3',
                        url: AUDIO.src,
                        autoLoad: true,
                        autoPlay: false,
                        volume: 100,
                        onload: () => {
                            console.log('音乐加载完成');
                            // 预加载图片
                            const imagesToLoad = [...ROUTE_INFO, ...PHOTOS, ...WANNATO]
                                .filter(item => item.contentType === 'image')
                                .map(item => item.content);
                            console.log('预加载图片:', imagesToLoad);

                            preLoadImages(imagesToLoad, () => {
                                console.log('图片预加载完成');
                                setTimeout(() => {
                                    const loading = document.getElementById('loading');
                                    loading.innerHTML = `
                                        <div>
                                            <div style="font-size: 24px; margin-bottom: 20px;">${TEXT.START}</div>
                                            <button id="startButton">点击开始</button>
                                        </div>
                                    `;
                                    
                                    // 绑定开始按钮点击事件
                                    const startButton = document.getElementById('startButton');
                                    if (startButton) {
                                        startButton.addEventListener('click', handleStartClick);
                                        startButton.addEventListener('touchstart', handleStartClick);
                                    }
                                }, 1000);
                            });
                        },
                        onerror: (errorCode) => {
                            console.error('音乐加载失败，错误代码:', errorCode);
                            // 即使音乐加载失败也继续
                            const imagesToLoad = [...ROUTE_INFO, ...PHOTOS, ...WANNATO]
                                .filter(item => item.contentType === 'image')
                                .map(item => item.content);
                            
                            preLoadImages(imagesToLoad, () => {
                                setTimeout(() => {
                                    const loading = document.getElementById('loading');
                                    loading.innerHTML = `
                                        <div>
                                            <div style="font-size: 24px; margin-bottom: 20px;">${TEXT.START}</div>
                                            <button id="startButton">点击开始</button>
                                        </div>
                                    `;
                                    
                                    const startButton = document.getElementById('startButton');
                                    if (startButton) {
                                        startButton.addEventListener('click', handleStartClick);
                                        startButton.addEventListener('touchstart', handleStartClick);
                                    }
                                }, 1000);
                            });
                        }
                    });
                }).catch(error => {
                    console.error('配置加载失败:', error);
                    alert('配置加载失败，请刷新页面重试');
                });
            };

            // 初始化SoundManager
            soundManager.setup({
                url: './sm/',
                preferFlash: false,
                useFlashBlock: false,
                useHTML5Audio: true,
                html5PollingInterval: 50,
                onready: initMP3,
                ontimeout: () => {
                    console.error('SoundManager初始化超时，尝试使用原生音频');
                    // 使用原生HTML5 Audio作为备用方案
                    useNativeAudio();
                }
            });

            // 原生HTML5 Audio备用方案
            function useNativeAudio() {
                console.log('使用原生HTML5 Audio API');
                window.ConfigManager.getConfig().then(config => {
                    COORDS = config.COORDS;
                    LOCATIONS = config.LOCATIONS;
                    ROUTE_INFO = config.ROUTE_INFO;
                    PHOTOS = config.PHOTOS;
                    WANNATO = config.WANNATO;
                    MARKER_TEXT = config.MARKER_TEXT;
                    AUDIO = config.AUDIO;
                    IMAGES = config.IMAGES;
                    TEXT = config.TEXT;
                    ANIMATION = config.ANIMATION;
                    SHARE = config.SHARE;

                    // 创建原生Audio对象
                    MUSIC = new Audio(AUDIO.src);
                    MUSIC.load();
                    
                    // 添加兼容方法
                    MUSIC.playState = 0;
                    MUSIC.paused = true;
                    
                    // 添加播放事件监听
                    MUSIC.addEventListener('play', () => {
                        console.log('音频开始播放');
                        MUSIC.playState = 1;
                        MUSIC.paused = false;
                    });
                    
                    MUSIC.addEventListener('pause', () => {
                        console.log('音频暂停');
                        MUSIC.paused = true;
                    });
                    
                    MUSIC.addEventListener('ended', () => {
                        console.log('音频播放结束');
                        MUSIC.playState = 0;
                        MUSIC.paused = true;
                    });
                    
                    MUSIC.addEventListener('canplay', () => {
                        console.log('原生音频加载完成');
                        MUSIC.playState = 1;
                        
                        // 预加载图片
                        const imagesToLoad = [...ROUTE_INFO, ...PHOTOS, ...WANNATO]
                            .filter(item => item.contentType === 'image')
                            .map(item => item.content);
                        console.log('预加载图片:', imagesToLoad);

                        preLoadImages(imagesToLoad, () => {
                            console.log('图片预加载完成');
                            setTimeout(() => {
                                const loading = document.getElementById('loading');
                                loading.innerHTML = `
                                    <div>
                                        <div style="font-size: 24px; margin-bottom: 20px;">${TEXT.START}</div>
                                        <button id="startButton">点击开始</button>
                                    </div>
                                `;
                                
                                // 绑定开始按钮点击事件
                                const startButton = document.getElementById('startButton');
                                if (startButton) {
                                    startButton.addEventListener('click', handleStartClick);
                                    startButton.addEventListener('touchstart', handleStartClick);
                                }
                            }, 1000);
                        });
                    });

                    MUSIC.addEventListener('error', (e) => {
                        console.error('原生音频加载失败:', e);
                        // 即使音频加载失败也继续
                        const imagesToLoad = [...ROUTE_INFO, ...PHOTOS, ...WANNATO]
                            .filter(item => item.contentType === 'image')
                            .map(item => item.content);
                        
                        preLoadImages(imagesToLoad, () => {
                            setTimeout(() => {
                                const loading = document.getElementById('loading');
                                loading.innerHTML = `
                                    <div>
                                        <div style="font-size: 24px; margin-bottom: 20px;">${TEXT.START}</div>
                                        <button id="startButton">点击开始</button>
                                    </div>
                                `;
                                
                                const startButton = document.getElementById('startButton');
                                if (startButton) {
                                    startButton.addEventListener('click', handleStartClick);
                                    startButton.addEventListener('touchstart', handleStartClick);
                                }
                            }, 1000);
                        });
                    });
                }).catch(error => {
                    console.error('配置加载失败:', error);
                    alert('配置加载失败，请刷新页面重试');
                });
            }
        };

        // 添加页面可见性变化监听，处理页面切换时的音频问题
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // 页面隐藏时暂停音乐
                if (MUSIC) {
                    try {
                        MUSIC.pause();
                    } catch (e) {
                        console.error('暂停音乐失败:', e);
                    }
                }
            } else {
                // 页面显示时恢复音乐
                if (MUSIC && MUSIC.paused) {
                    try {
                        if (typeof MUSIC.resume === 'function') {
                            MUSIC.resume();
                        } else {
                            MUSIC.play();
                        }
                    } catch (e) {
                        console.error('恢复音乐失败:', e);
                    }
                }
            }
        });
    </script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?c142366bae08a5add7c3c1ce2703b10d";
            var s = document.getElementsByTagName("script")[0];
            console.log(s);
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</body>

</html>