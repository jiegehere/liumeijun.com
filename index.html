<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <title> Hello My Dear </title>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?238d955ace49b79a20fb59344f390016";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            height: 100%;
            width: 100%;
            font-family: 'Microsoft Yahei', 'Helvetica Neue', Helvetica, Arial, Sans-serif;
        }

        #bdMapContainer {
            height: 100%;
            width: 100%;
        }

        #loading {
            height: 100%;
            width: 100%;
            position: absolute;
            z-index: 999;
            background: url("./uploads/site/loading.gif") no-repeat center center #FFFAD1;
            top: 0;
            left: 0;
            text-align: center;
            line-height: 300px;
            font-size: 32px;
            color: #666;
            cursor: pointer;
        }

        #theEnd {
            height: 0%;
            width: 100%;
            line-height: 0;
            font-size: 0;
            overflow: hidden;
            position: absolute;
            z-index: 999;
            background-color: #FFFAD1;
            top: 0;
            left: 0;
        }

        #theEndText {
            position: absolute;
            left: 0;
            z-index: 9999;
            width: 100%;
            text-align: center;
            font-size: 26px;
            line-height: 2;
            top: 50%;
            margin-top: -100px;
            height: 200px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:active {
            background-color: #3d8b40;
        }
        .btn_pasue_play {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 999;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
        }

        .btn_pasue_play:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .btn_pasue_play:active {
            transform: translateX(-50%) scale(0.98);
        }
    </style>
</head>

<body>
    <div id="loading">正在加载...</div>
    <div id="theEnd"></div>
    <div id="bdMapContainer"></div>
    <div><button id="pauseBtn" class="btn_pasue_play" onclick="pausePlay()">暂停</button></div>

    <script type="text/javascript">

        // ==================== 工具函数 ====================

        // 判断是否移动端，包括微信内、或者手机浏览器
        const isMobile = (function () {
            const userAgent = navigator.userAgent.toLowerCase();
            // 检测移动设备标识
            const mobileKeywords = [
                'mobile',      // 通用移动端标识
                'android',     // Android
                'iphone',      // iPhone
                'ipad',        // iPad
                'ipod',        // iPod
                'windows phone', // Windows Phone
                'blackberry',  // BlackBerry
                'opera mini',  // Opera Mini
                'opera mobi',  // Opera Mobile
            ];
            // 检测微信环境
            const isWeixin = /micromessenger/i.test(userAgent);
            // 检测是否触摸设备
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            // 检测屏幕尺寸（小于 768px 视为移动端）
            const isSmallScreen = window.innerWidth < 768;
            // 综合判断：满足任一条件即为移动端
            const hasMobileKeyword = mobileKeywords.some(keyword => userAgent.includes(keyword));
            const isMobileDevice = hasMobileKeyword || (isTouchDevice && isSmallScreen);
            console.log('设备检测:', {
                userAgent: userAgent.substring(0, 50) + '...',
                isWeixin: isWeixin,
                isTouchDevice: isTouchDevice,
                isSmallScreen: isSmallScreen,
                hasMobileKeyword: hasMobileKeyword,
                isMobileDevice: isMobileDevice
            });

            return isMobileDevice;
        })();

        // 判断是否预览模式，url参数中包括preview=1
        const isPreview = window.location.search.includes('preview=1');

        /**
         * 异步延迟函数
         * @param {number} ms - 延迟毫秒数
         * @returns {Promise}
         */
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * 数组随机排序
         * @param {Array} array - 要排序的数组
         * @returns {Array} - 随机排序后的数组
         */
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        /**
         * 预加载图片
         * @param {Array} imageUrls - 图片URL数组
         * @returns {Promise}
         */
        const preloadImages = (imageUrls) => {
            return new Promise((resolve) => {
                let loadedCount = 0;
                const total = imageUrls.length;

                if (total === 0) {
                    resolve();
                    return;
                }

                imageUrls.forEach(url => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        if (loadedCount === total) {
                            resolve();
                        }
                    };
                    img.onerror = () => {
                        loadedCount++;
                        if (loadedCount === total) {
                            resolve();
                        }
                    };
                    img.src = url;
                });
            });
        };

        /**
         * 下滑动画
         * @param {string} elementId - 元素ID
         * @param {number} duration - 动画持续时间（毫秒）
         * @returns {Promise}
         */
        const slideDownAnimation = (elementId, duration = 1000) => {
            return new Promise((resolve) => {
                const element = document.getElementById(elementId);
                const startTime = Date.now();
                const startHeight = 0;
                const endHeight = 100;
                const step = 10; // 每10ms更新一次

                element.style.display = 'block';
                element.style.height = '0%';

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const currentHeight = startHeight + (endHeight - startHeight) * progress;

                    element.style.height = currentHeight + '%';

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        resolve();
                    }
                };

                animate();
            });
        };

        /**
        * 复制当前页面链接，并引导用户分享到微信
        */
        function shareToWechat() {
            // 1. 获取当前页面完整链接（包含参数）
            const currentUrl = window.location.href;

            // 2. 复制链接到剪贴板
            navigator.clipboard.writeText(currentUrl)
                .then(() => {
                    // 3. 弹出友好提示，引导用户操作
                    alert("页面链接已复制！\n请打开微信，粘贴给好友或朋友圈即可分享");
                    // 进阶：可以用自定义弹窗（代替 alert），体验更好
                })
                .catch((err) => {
                    // 兼容：部分浏览器不支持 Clipboard API（备用方案：手动选择链接）
                    console.error("复制失败，请手动复制页面地址：", err);
                    // 创建临时输入框，让用户手动复制
                    const tempInput = document.createElement("input");
                    tempInput.value = currentUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    alert("页面链接已复制！\n请打开微信，粘贴给好友或朋友圈即可分享");
                });
        }

        /**
         * 制作同款， 展示一个弹窗说明文案和二维码图片，引导用户扫描二维码 或者访问报错时咨询客服
         */
        function makeMyVersion(showText = '') {
            const qrCodeImgUrl = './uploads/images/qrcode.png';
            if (!showText) {
                showText = '<p>扫描二维码，即可制作同款，生成专属链接，所有内容自定义！</p>';
            }

            // 1. 先判断弹窗是否已存在，避免重复创建
            if (document.getElementById('qr-modal')) {
                document.getElementById('qr-modal').style.display = 'flex';
                return;
            }

            // 2. 创建弹窗遮罩层（全屏半透明背景）
            const modalMask = document.createElement('div');
            modalMask.id = 'qr-modal';
            modalMask.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* 确保弹窗在最上层 */
        padding: 20px; /* 移动端左右内边距，避免弹窗贴边 */
        box-sizing: border-box;
    `;

            // 3. 创建弹窗主体（居中容器）
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
        background-color: #ffffff;
        border-radius: 12px; /* 圆角，提升美观度 */
        padding: 24px;
        width: 100%;
        max-width: 320px; /* 限制最大宽度，PC 端不显得过宽 */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); /* 阴影，突出弹窗 */
        box-sizing: border-box;
        position: relative; /* 为关闭按钮定位做准备 */
        text-align: center; /* 文案和图片居中 */
    `;

            // 4. 创建文案元素（上方）
            const modalText = document.createElement('div');
            modalText.innerHTML = showText;
            modalText.style.cssText = `
        margin: 0 0 20px 0; /* 文案下方留间距，隔开二维码 */
        font-size: 16px;
        color: #333333;
        line-height: 1.5; /* 行高，提升可读性 */
    `;

            // 5. 创建二维码图片元素（下方）
            const qrImg = document.createElement('img');
            qrImg.src = qrCodeImgUrl;
            qrImg.alt = '制作同款二维码';
            qrImg.style.cssText = `
        width: 100%;
        max-width: 200px; /* 限制二维码最大宽度 */
        height: auto; /* 自适应高度，保持图片比例 */
        display: inline-block; /* 居中对齐 */
        border: 1px solid #eeeeee; /* 轻微边框，提升美观 */
        border-radius: 8px;
    `;

            // 6. 创建关闭按钮（右上角）
            const closeBtn = document.createElement('button');
            closeBtn.innerText = '×';
            closeBtn.style.cssText = `
        position: absolute;
        top: 12px;
        right: 12px;
        width: 28px;
        height: 28px;
        border: none;
        background-color: transparent;
        font-size: 24px;
        color: #999999;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        margin: 0;
        transition: color 0.2s ease; /*  hover 过渡效果 */
    `;

            // 7. 关闭按钮 hover 样式（仅 PC 端生效，移动端无 hover）
            closeBtn.onmouseover = function () {
                this.color = '#333333';
            };
            closeBtn.onmouseout = function () {
                this.color = '#999999';
            };

            // 8. 绑定关闭事件（点击按钮关闭弹窗）
            function closeModal() {
                modalMask.style.display = 'none';
            }
            closeBtn.addEventListener('click', closeModal);

            // 额外：点击遮罩层空白处也关闭弹窗（提升用户体验）
            modalMask.addEventListener('click', function (e) {
                if (e.target === modalMask) {
                    closeModal();
                }
            });

            // 9. 组装弹窗元素（按「文案 → 二维码 → 关闭按钮」的顺序）
            modalContent.appendChild(modalText);
            modalContent.appendChild(qrImg);
            modalContent.appendChild(closeBtn);
            modalMask.appendChild(modalContent);

            // 10. 将弹窗添加到页面中
            document.body.appendChild(modalMask);

            // 兼容：防止移动端弹窗出现滚动穿透
            document.body.style.overflow = 'hidden';
            modalMask.onremove = function () {
                document.body.style.overflow = 'auto';
            };
        }

        // ==================== 地图操作工具类 ====================

        class MapUtils {
            constructor(map, isMobile = false) {
                this.isMobile = isMobile;
                this.map = map;
            }

            /**
             * 地图居中并缩放
             * @param {Object} BMap.Point - 目标点
             * @param {number} zoomLevel - 目标缩放级别
             */
            centerAndZoom(point, zoomLevel) {
                this.map.centerAndZoom(point, zoomLevel);
            }

            /**
             * 禁用地图拖拽
             */
            disableDragging() {
                this.map.disableDragging();
            }

            /**
             * 禁用地图双击缩放
             */
            disableDoubleClickZoom() {
                this.map.disableDoubleClickZoom();
            }

            /**
             * 地图平移动画
             * @param {Object} point - 目标点 {lng, lat}
             * @param {number} delay - 延迟时间（毫秒）
             * @param {string} address - 目标地址（可选）, 仅用于打日志
             */
            async panTo(point, delay = 1000, address = null) {
               if (isPaused) {
                    await new Promise(resolve => {
                        const checkPause = setInterval(() => {
                            if (!isPaused) {
                                clearInterval(checkPause);
                                resolve();
                            }
                        }, 100);
                    });
                }

                console.log('开始平移动画到地址:', address, ' 延迟:', delay, ' 目标点:', point);
                this.map.panTo(new BMap.Point(point.lng, point.lat));
                await sleep(delay);
            }

            /**
            * 获取两个点的中间位置， 大概精度，不是很精准
            * @param {Object} point1 - 百度坐标点 点1 {lng, lat}
            * @param {Object} point2 - 百度坐标点 点2 {lng, lat}
            * @returns {Object} - 中间位置点 {lng, lat}
            */
            getCenterPoint(point1, point2) {
                const centerLng = (point1.lng + point2.lng) / 2;
                const centerLat = (point1.lat + point2.lat) / 2;
                return { lng: centerLng, lat: centerLat };
            }

            /**
             * 地图缩放动画
             * @param {number} level - 目标缩放级别
             * @param {number} speed - 每次缩放的间隔时间（毫秒）
             * @param {Object} point - 目标点（可选）
             * @param {string} address - 目标地址（可选）, 仅用于打日志
             */
            async zoomTo(level, speed = 800, point = null, address = null) {
                console.log('开始缩放地图到级别:', level, ' 地址:', address, ' 速度:', speed, ' 目标点:', point);
                return new Promise((resolve) => {
                    let timeoutId;

                    const loopZoom = () => {
                        const curZoom = this.map.getZoom();

                        if (curZoom === level) {
                            clearTimeout(timeoutId);
                            resolve();
                            return;
                        }

                        const direction = curZoom > level ? -1 : 1;
                        const toZoom = curZoom + direction;

                        this.map.setZoom(toZoom);

                        if (point) {
                            this.map.setCenter(new BMap.Point(point.lng, point.lat));
                        }

                        timeoutId = setTimeout(loopZoom, speed);
                    };

                    loopZoom();
                });
            }

            /**
             * 添加标记点
             * @param {Object} point - 坐标点 {lng, lat}
             * @param {string} animation - 动画类型
             */
            addMarker(point, animation = null) {
                const marker = new BMap.Marker(new BMap.Point(point.lng, point.lat));
                this.map.addOverlay(marker);
                if (animation) {
                    marker.setAnimation(animation);
                }
                return marker;
            }

            /**
             * 清除所有覆盖物
             */
            clearOverlays() {
                this.map.clearOverlays();
            }

            /**
             * 设置地图类型
             * @param {number} mapType - 地图类型
             */
            setMapType(mapType) {
                this.map.setMapType(mapType);
            }

            /**
             * 打开信息窗口
             * @param {string} content - 内容
             * @param {Object} point - 坐标点 {lng, lat}
             * @param {string} title - 标题
             */
            openInfoWindow(content, point, title = '') {
                // 检测是否为移动端
                const isMobile = window.innerWidth <= 768;
                const windowWidth = isMobile ? Math.min(window.innerWidth - 40, 320) : 600;

                const opts = {
                    title: title,
                    width: windowWidth,
                    maxWidth: windowWidth,
                    enableMessage: false
                };
                const infoWindow = new BMap.InfoWindow(content, opts);
                this.map.openInfoWindow(infoWindow, new BMap.Point(point.lng, point.lat));
                infoWindow.redraw();
            }

            /**
             * 关闭信息窗口
             */
            closeInfoWindow() {
                this.map.closeInfoWindow();
            }

            /**
             * 自动调整地图视口，使所有点都在屏幕范围内可见
             * @param {Array} points - 坐标点数组 [{lng, lat}, ...]
             * @param {Object} options - 选项 {margins: [top, right, bottom, left]}
             */
            autoFitView(points, options = {}) {
                if (!points || points.length === 0) {
                    return;
                }

                // 转换为 BMap.Point 数组
                const bmapPoints = points.map(p => new BMap.Point(p.lng, p.lat));

                // 设置默认边距（移动端需要更大的边距） 
                const defaultMargins = this.isMobile ? [2, 2, 2, 2] : [100, 100, 100, 100];
                const margins = options.margins || defaultMargins;

                // 调整视口
                console.log('调整视口， 边距:', margins);
                this.map.setViewport(bmapPoints, { margins: margins });
            }

            /**
             * 绘制驾车路线
             * @param {Object} start - 起点 {lng, lat}
             * @param {Object} end - 终点 {lng, lat}
             */
            async drawDrivingRoute(start, end) {
                return new Promise((resolve, reject) => {
                    const startPoint = new BMap.Point(start.lng, start.lat);
                    const endPoint = new BMap.Point(end.lng, end.lat);

                    console.log('开始搜索路线:', startPoint, '->', endPoint);

                    let isResolved = false;

                    // 设置超时处理
                    const timeoutId = setTimeout(() => {
                        if (!isResolved) {
                            isResolved = true;
                            console.warn('路线搜索超时，继续执行后续动画');
                            resolve();
                        }
                    }, 10000);

                    const driving = new BMap.DrivingRoute(this.map, {
                        renderOptions: {
                            map: this.map,
                            autoViewport: false,
                            panel: false
                        },
                        onSearchComplete: (result) => {
                            if (!isResolved) {
                                isResolved = true;
                                clearTimeout(timeoutId);
                                console.log('路线规划成功');
                                // 调整视野以显示完整路线
                                const plan = result.getPlan(0);
                                if (plan) {
                                    const route = plan.getRoute(0);
                                    if (route && route.getPath) {
                                        const path = route.getPath();
                                        if (path && path.length > 0) {
                                            this.map.setViewport(path, { margins: [100, 100, 100, 100] });
                                        }
                                    }
                                }
                                setTimeout(() => {
                                    resolve();
                                }, 100);
                            }
                        },
                        onPolylinesSet: () => {
                            console.log('路线折线已设置');
                        }
                    });

                    // 搜索路线
                    driving.search(startPoint, endPoint);
                    console.log('路线搜索请求已发送');
                });
            }
        }

        // ==================== 展示控制器 ====================

        class ShowController {
            constructor(map, config, isMobile = false) {
                this.isMobile = isMobile
                this.mapUtils = new MapUtils(map, isMobile);
                this.config = config;
                this.audio = null;
                this.preloadedImages = {}; // 存储预加载的图片对象
            }

            /**
             * 初始化音频
             */
            async initAudio() {
                return new Promise((resolve) => {
                    try {
                        // 获取音频URL
                        var audioUrl = this.config.basicCfg?.audioUrl;
                        if (!audioUrl) {
                            alertDebug('未配置音频URL');
                            resolve();
                            return;
                        }

                        // 创建音频对象
                        // audioUrl 不包含域名情况，不是http或https，添加域名
                        if (!audioUrl.startsWith('http')) {
                            // 去掉前面的 ./ 或 ../
                            audioUrl = audioUrl.replace(/^\.\//, '');
                            audioUrl = window.location.origin + '/' + audioUrl;
                        }
                        alertDebug('音频URL:' + audioUrl);
                        if (this.audio) {
                            alertDebug('音频对象已存在');
                            resolve();
                        }
                        this.audio = new Audio(audioUrl);

                        // 微信浏览器兼容处理：设置音频属性
                        this.audio.loop = false; //默认不循环播放
                        this.audio.preload = 'auto';

                        // 设置超时机制（微信浏览器可能不会触发 oncanplay）
                        let resolved = false;
                        const timeout = setTimeout(() => {
                            if (!resolved) {
                                resolved = true;
                                alertDebug('音频初始化超时，继续执行');
                                resolve();
                            }
                        }, 3000); // 3秒超时

                        // 监听音频可以播放事件
                        this.audio.oncanplay = () => {
                            if (!resolved) {
                                resolved = true;
                                clearTimeout(timeout);
                                alertDebug('音频加载完成，可以播放');
                                resolve();
                            }
                        };

                        // 监听错误事件
                        this.audio.onerror = (e) => {
                            if (!resolved) {
                                resolved = true;
                                clearTimeout(timeout);
                                alertDebug('音频加载失败:' + e.message);
                                // 即使加载失败也继续，避免阻塞
                                resolve();
                            }
                        };

                        // 监听 loadeddata 事件（比 oncanplay 更早触发）
                        this.audio.onloadeddata = () => {
                            if (!resolved) {
                                resolved = true;
                                clearTimeout(timeout);
                                alertDebug('音频数据加载完成');
                                resolve();
                            }
                        };

                        this.audio.load();
                    } catch (error) {
                        alertDebug('创建音频对象失败:' + error.message, true);
                        resolve();
                        return;
                    }
                });
            }

            /**
             * 播放音频
             */
            playAudio() {
                if (this.audio) {
                    // 微信浏览器兼容处理
                    if (typeof WeixinJSBridge !== 'undefined') {
                        WeixinJSBridge.invoke('getNetworkType', {}, function (e) {
                            console.log('微信网络类型:', e.err_msg);
                        });
                    }

                    const playPromise = this.audio.play();

                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('音频播放成功');
                        }).catch(err => {
                            console.error('音频播放失败:', err);
                            // 尝试重新加载并播放
                            this.audio.load();
                            this.audio.play().catch(e => {
                                console.error('重试播放失败:', e);
                            });
                        });
                    }
                }
            }

            /**
             * 暂停音频
             */
            pauseAudio() {
                if (this.audio) {
                    this.audio.pause();
                }
            }

            /**
             * 开始展示流程
             */
            async start() {
                alertDebug('开始展示流程');
                try {
                    // 1. 从 API 加载配置、初始化地图
                    // 已经挪出去了

                    // 2. 预加载所有图片
                    await this.preloadAllImages();

                    // 3. 初始化音频
                    await this.initAudio();

                    // 4. 显示开始按钮
                    await this.showStartButton();

                } catch (error) {
                    console.error('初始化失败:', error);
                    alert('初始化失败：' + error.message, true);
                }
            }

            /**
             * 预加载所有图片
             */
            async preloadAllImages() {
                const imageUrls = [];

                // 从 showList 中提取所有图片
                this.config.showList.forEach(item => {
                    item.locations.forEach(loc => {
                        if (loc.showImgUrl) {
                            imageUrls.push(loc.showImgUrl);
                        }
                    });
                });
                await this.preloadImages(imageUrls);
                alertDebug('所有图片预加载完成, 数量:' + imageUrls.length);
            }

            /**
             * 预加载图片（存储预加载的图片对象）
             * @param {Array} imageUrls - 图片URL数组
             */
            preloadImages(imageUrls) {
                return new Promise((resolve) => {
                    let loadedCount = 0;
                    const total = imageUrls.length;

                    if (total === 0) {
                        resolve();
                        return;
                    }

                    imageUrls.forEach(url => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous'; // 允许跨域
                        img.onload = () => {
                            // 将预加载的图片转换为 data URL 存储
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                                // 存储 data URL
                                this.preloadedImages[url] = dataUrl;
                                // console.log('图片转换为 data URL:', url.substring(0, 30) + '...');
                            } catch (e) {
                                console.warn('图片转换失败，使用原始 URL:', e);
                                this.preloadedImages[url] = url;
                            }

                            loadedCount++;
                            if (loadedCount === total) {
                                resolve();
                            }
                        };
                        img.onerror = () => {
                            console.error('图片加载失败:', url);
                            this.preloadedImages[url] = url; // 失败时使用原始 URL
                            loadedCount++;
                            if (loadedCount === total) {
                                resolve();
                            }
                        };
                        img.src = url;
                    });
                });
            }

            /**
             * 显示开始按钮
             */
            showStartButton() {
                alertDebug('显示开始按钮');
                const loading = document.getElementById('loading');
                loading.innerHTML = '点击开始';
                loading.onclick = async () => {
                    // 先播放音频（微信浏览器需要用户交互才能播放）
                    this.playAudio();

                    // 进入全屏
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    }

                    // 预览模式，展示暂停按钮
                    if (isPreview) {
                        document.getElementById('pauseBtn').style.display = 'block';
                    } else {
                        // 非预览模式，隐藏暂停按钮
                        document.getElementById('pauseBtn').style.display = 'none';
                    }

                    // 开始展示
                    await this.runShowFlow();
                    
                    // 最后也隐藏一下
                    document.getElementById('pauseBtn').style.display = 'none';
                };
            }

            /**
             * 运行展示流程
             */
            async runShowFlow() {
                try {
                    // 隐藏加载层
                    document.getElementById('loading').style.display = 'none';

                    // // 调试结束画面使用
                    // await this.showEndScreen();
                    // await this.executeEndShow();

                    // 按 order 排序 showList
                    const sortedShowList = [...this.config.showList].sort((a, b) => a.order - b.order);

                    //顺序执行每个展示项
                    for (const showItem of sortedShowList) {
                        // if (showItem.type != 3) {
                        //     continue;
                        // }
                        await this.executeShowItem(showItem);
                    }

                    // 执行结束展示
                    await this.executeEndShow();

                } catch (error) {
                    console.error('展示流程执行失败:', error);
                    alert('展示失败：' + error.message);
                }
            }

            /**
             * 执行展示项
             * @param {Object} showItem - 展示项配置
             */
            async executeShowItem(showItem) {
                console.log(`执行展示项: ${showItem.chapterName} (type: ${showItem.type})`);
                console.log("showItem:", showItem);

                // 先调整缩放级别
                console.log('this.config:', this.config);
                var zoomSpeed = showItem?.zoomSpeed || this.config.basicCfg.globalZoomSpeed;
                console.log('zoomSpeed:', zoomSpeed);
                await this.mapUtils.zoomTo(showItem.zoomLevel, zoomSpeed, showItem.startPoint, showItem.startAddress);
                console.log('地图重置完成');

                // 重置地图到起点
                await this.mapUtils.panTo(showItem.startPoint, 1000, showItem.startAddress);

                // 展示章节主题
                var mockLocation = {
                    "showText": showItem.chapterName, 
                    "showImgUrl": "", 
                    "point": {
                        "lng": showItem.startPoint.lng,
                        "lat": showItem.startPoint.lat
                    }
                }
                await this.showLocationWindowInfo(mockLocation);
                // 根据类型执行不同的展示逻辑
                console.log(' =========== 开始执行展示类型:', showItem.type, " =========== ");
                switch (showItem.type) {
                    case 1:
                        await this.showType1(showItem);
                        break;
                    case 2: // 路线展示
                        await this.showType2(showItem);
                        break;
                    case 3: // 一起去过的地方
                        await this.showType3(showItem);
                        break;
                    
                    case 4: // 想去的地方
                        await this.showType4(showItem);
                        break;
                    default:
                        console.warn('未知的展示类型:', showItem.type);
                }
                console.log(`showType ${showItem.type} ${showItem.chapterName} 执行完成`);
            }

            /**
             * 展示类型1：顺序展示地点位置，每个展示后增加标记弹跳效果
             * @param {Object} showItem - 展示项配置
             */
            async showType1(showItem) {
                for (const location of showItem.locations) {
                    // 移动到地点
                    await this.mapUtils.panTo(location.point, 1000, location.address);
                    await this.mapUtils.zoomTo(16, 800, location.point, location.address);

                    await this.showLocationWindowInfo(location, 2000);

                    // 添加弹跳标记
                    this.mapUtils.addMarker(location.point, BMAP_ANIMATION_BOUNCE);
                    console.log('添加弹跳标记:', location.address);

                    await this.mapUtils.zoomTo(9, 800, location.point, location.address);
                    // 等待一段时间
                    await sleep(3000);
                }
            }

            /**
             * 展示类型2：展示两个地方之间的路线
             * @param {Object} showItem - 展示项配置
             */
            async showType2(showItem) {
                console.log('开始执行 showType2');

                if (showItem.locations.length !== 2) {
                    console.error('类型2需要恰好2个地点');
                    return;
                }
                 
                const [loc1, loc2] = showItem.locations;
                console.log('地点1:', loc1, '地点2:', loc2);
                /*
                // 显示第一个地点
                console.log('移动到地点1');
                await this.mapUtils.panTo(loc1.point, 1000);
                console.log('缩放到地点1');
                await this.mapUtils.zoomTo(16, 800, loc1.point);
                console.log('添加标记1');
                this.mapUtils.addMarker(loc1.point, BMAP_ANIMATION_BOUNCE);
                console.log('等待1秒');
                await sleep(1000);

                // 显示第二个地点
                console.log('移动到地点2');
                await this.mapUtils.panTo(loc2.point, 1000);
                console.log('缩放到地点2');
                await this.mapUtils.zoomTo(16, 800, loc2.point);
                console.log('添加标记2');
                this.mapUtils.addMarker(loc2.point, BMAP_ANIMATION_BOUNCE);
                console.log('等待1秒');
                await sleep(1000);
                */

                // 地图平移到中间位置
                await this.mapUtils.panTo(this.mapUtils.getCenterPoint(loc1.point, loc2.point), 1000);
                console.log('地图平移到中间位置');

                // 绘制路线
                console.log('开始绘制路线');
                await this.mapUtils.drawDrivingRoute(loc1.point, loc2.point);
                console.log('路线绘制完成，等待2秒');
                await sleep(2000);

                await this.showLocationWindowInfo(loc1);
                await this.showLocationWindowInfo(loc2);

                console.log('showType2 完成');
            }

            /**
             * 展示类型3：展示一起去过的地方，顺序展示location位置
             * 因为是具体地点，缩放搞快点
             * @param {Object} showItem - 展示项配置
             */
            async showType3(showItem) {
                this.mapUtils.clearOverlays();
                var speed = showItem?.zoomSpeed || this.config.basicCfg.globalZoomSpeed;
                var bigLevelSpeed = parseInt(speed * 0.15); 
                var bigLevel = (showItem.zoomLevel - 4) > 0 ? showItem.zoomLevel - 4 : 1;
                for (const location of showItem.locations) {
                    await this.mapUtils.zoomTo(bigLevel, bigLevelSpeed, showItem.startPoint, showItem.startAddress);
                    await this.mapUtils.panTo(location.point, speed, location.address);
                    await this.mapUtils.zoomTo(showItem.zoomLevel, speed, location.point, location.address);
                    await this.showLocationWindowInfo(location);
                }
            }

            /**
             * 展示类型4：想去的地方
             * @param {Object} showItem - 展示项配置
             */
            async showType4(showItem) {
                this.mapUtils.clearOverlays();
                var speed = showItem?.zoomSpeed || this.config.basicCfg.globalZoomSpeed;
                var bigLevelSpeed = parseInt(speed * 0.4); 
                var bigLevel = (showItem.zoomLevel - 2) > 0 ? showItem.zoomLevel - 2 : 1;
                for (const location of showItem.locations) {
                    await this.mapUtils.zoomTo(bigLevel, bigLevelSpeed, showItem.startPoint, showItem.startAddress);
                    await this.mapUtils.panTo(location.point, speed, location.address);
                    await this.mapUtils.zoomTo(showItem.zoomLevel, speed, location.point, location.address);
                    await this.showLocationWindowInfo(location);
                }
            }

            
            /**
             * 展示地点信息窗口
             * @param {Object} location - 地点配置
             * @param {number} showTime - 展示时间（毫秒）
             */
            async showLocationWindowInfo(location, showTime = 2500) {
                // 如果有图片或文本，显示信息窗口
                if (location.showImgUrl || location.showText) {
                    let content = `<div>${location.showText}</div>`;
                    if (location.showImgUrl) {
                        // 使用预加载的图片 data URL
                        const preloadedSrc = this.preloadedImages[location.showImgUrl];
                        console.log('使用预加载图片:', location.showImgUrl);
                        console.log('预加载源:', preloadedSrc ? preloadedSrc.substring(0, 50) + '...' : '未找到');

                        const isMobile = window.innerWidth <= 768;
                        const maxHeight = isMobile ? '250px' : '400px';

                        // 使用预加载的 data URL 或原始 URL
                        const imgSrc = preloadedSrc || location.showImgUrl;

                        content = `
                                <div>${location.showText}</div>
                                <div style="width: 100%; max-height: ${maxHeight}; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
                                    <img src="${imgSrc}" 
                                         style="max-width: 100%; max-height: ${maxHeight}; width: auto; height: auto; object-fit: contain; display: block;" 
                                         alt="${location.showText || 'Image'}" />
                                </div>
                            `;
                    }
                    this.mapUtils.openInfoWindow(content, location.point);
                    // 等待一段时间
                    await sleep(showTime);
                    // 关闭信息窗口
                    this.mapUtils.closeInfoWindow();
                }
            }

            /**
             * 执行结束展示
             */
            async executeEndShow() {
                const endCfg = this.config.endShowCfg;

                // 移动到结束位置
                await this.mapUtils.panTo(endCfg.endMapCenterPoint, 800, endCfg.endMapCenterAddress);
                var zoomLevel = endCfg.zoomLevel
                await this.mapUtils.zoomTo(zoomLevel, 800, endCfg.endMapCenterPoint, endCfg.endMapCenterAddress);

                // 切换到卫星图
                this.mapUtils.setMapType(BMAP_HYBRID_MAP);

                // 随机打乱标记点
                const shuffledMarkers = shuffleArray(endCfg.markerList);

                // 自动调整地图视口，使所有标记点都在屏幕范围内可见
                await sleep(500);
                this.mapUtils.autoFitView(shuffledMarkers);

                // 顺序添加标记点
                for (const marker of shuffledMarkers) {
                    this.mapUtils.addMarker(marker, BMAP_ANIMATION_DROP);
                    await sleep(300);
                }

                // 等待4秒后显示结束画面
                await sleep(4000);
                await this.showEndScreen();
            }

            /**
             * 显示结束画面
             */
            async showEndScreen() {
                await slideDownAnimation('theEnd', 1500);
                const theEndText = document.getElementById('theEnd');
                const endText = this.config.endShowCfg.endText || '';
                theEndText.innerHTML = `
                    <div id="theEndText">
                        ${endText}<br /><br />
                        <button onclick="window.location.reload();">再看一次</button>
                        <button onclick="shareToWechat()">分享</button>
                        <button onclick="makeMyVersion()">制作同款</button>
                    </div>
                `;
            }
        }

        // ==================== 页面初始化 ====================

        let map;
        let showController;
        let debugAlert = false;
        let configData = {};
        let isPaused = false; // 全局变量，用于控制

        function pausePlay() {
            isPaused = !isPaused;
            if (isPaused) {
                showController.pauseAudio();
                document.getElementById('pauseBtn').innerText = '播放';
            } else {
                showController.playAudio();
                document.getElementById('pauseBtn').innerText = '暂停';
            }
        }

        function alertDebug(msg, needAlert = false) {
            if (debugAlert || needAlert) {
                console.log(msg);
                alert(msg);
            } else {
                console.log(msg);
            }
        }

        /**
         * 初始化地图
         */
        async function initMap() {
            alertDebug('initMap 开始执行');
            try {
                // 防止重复初始化
                if (map) {
                    alertDebug('地图已经初始化，跳过');
                    return;
                }

                // 1. 从 API 加载配置
                apiRetData = await loadConfigFromApi();
                if (apiRetData.ret > 0) {
                    var msg = ('API返回错误码:' + apiRetData.ret + ' 错误描述: ' + apiRetData.errmsg) || '未知错误';
                    throw new Error(msg);
                    return;
                }
                if (!apiRetData.data || !apiRetData.data.basicCfg) {
                    throw new Error('API返回数据格式错误');
                    return;
                }
                configData = apiRetData.data || {};

                // 2. 初始化地图
                map = new BMap.Map("bdMapContainer");
                map.setMapType(BMAP_NORMAL_MAP);
                const point = new BMap.Point(
                    configData.basicCfg.initMapCenterPoint.lng,
                    configData.basicCfg.initMapCenterPoint.lat
                );
                //地图居中并缩放
                map.centerAndZoom(point, 4);
                map.clearOverlays();
                map.reset();
                // 禁用地图拖拽和双击缩放
                map.disableDragging();
                map.disableDoubleClickZoom();
                // 3.初始化展示控制器
                showController = new ShowController(map, configData, isMobile);
                // 4.开始展示流程
                showController.start();
            } catch (error) {
                console.error('初始化地图失败:', error);
                var msg = `<p style="font-size: 12px;color: gray;">${error.message}</p>`;
                makeMyVersion("页面初始化失败，请咨询客服!" + msg);
                return;
            }
        }

        /**
         * 从 API 加载配置
         */
        async function loadConfigFromApi() {
            try {
                // 从当前页面url参数获取 配置文件版本
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code') || '';

                // 1. 等待 fetch 请求完成，拿到实际的响应对象
                const response = await fetch('/api/getConfig?code=' + code);
                // 2. 判断响应状态是否正常（HTTP 状态码 200-299）
                if (response.ok) {
                    // 3. 等待 JSON 解析完成，返回配置数据
                    const apiRetData = await response.json();
                    alertDebug('加载API apiRetData:' + JSON.stringify(apiRetData));
                    return apiRetData;
                } else {
                    // 处理 HTTP 错误（如 404/500）
                    alertDebug('API 请求失败，状态码：' + response.status);
                    return {'ret':2000, 'errmsg':'API 请求失败，状态码：' + response.status, 'data':{}};
                }
            } catch (error) {
                // 处理网络错误（如断网、跨域）
                alertDebug('Error loading config from API:' + error.message);
                return {'ret':1000, 'errmsg':'获取配置失败，' + error.message, 'data':{}};
            }
        }

        /**
         * 加载百度地图脚本
         */
        function loadBaiduMapScript() {
            const script = document.createElement("script");
            script.src = "https://api.map.baidu.com/api?v=3.0&ak=EXl1klVct9z0GXE7KAkPUkawwDhDN0h9&callback=initMap";
            script.onload = function () {
                console.log('百度地图脚本加载完成');
                // 微信浏览器兼容：如果回调没有触发，手动调用
                // 严格检查：BMap 存在且 Map 构造函数可用
                if (typeof BMap !== 'undefined' && typeof BMap.Map === 'function' && !map) {
                    console.log('BMap 和 Map 构造函数已加载，手动调用 initMap');
                    setTimeout(initMap, 500);
                } else {
                    console.log('BMap 脚本已加载，但 Map 构造函数尚未就绪，等待检测机制');
                }
            };
            script.onerror = function () {
                console.error('百度地图脚本加载失败');
                alert('百度地图加载失败，请检查网络连接');
            };
            document.body.appendChild(script);
        }

        /**
         * 检测百度地图是否加载完成
         */
        function checkBaiduMapLoaded() {
            const maxAttempts = 50; // 最多尝试50次
            let attempts = 0;

            const checkInterval = setInterval(() => {
                attempts++;
                alertDebug(`检测百度地图加载状态，尝试 ${attempts}/${maxAttempts}`);
                // 严格检查：BMap 存在且 Map 构造函数可用
                if (typeof BMap !== 'undefined' && typeof BMap.Map === 'function') {
                    alertDebug("百度地图已加载完成，Map 构造函数可用")
                    clearInterval(checkInterval);
                    initMap();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    alert('百度地图加载超时，请刷新页面重试');
                }
            }, 3000); // 每3秒检测一次
        }

        /**
         * 页面加载完成后初始化
         */
        window.onload = function () {
            alertDebug('页面加载完成，开始加载百度地图');
            // 加载百度地图脚本
            loadBaiduMapScript();
            // 启动检测机制（微信浏览器兼容）
            checkBaiduMapLoaded();
        };
    </script>
</body>

</html>