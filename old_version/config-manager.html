<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>配置管理</title>
    <style type="text/css">
        body {
            font-family: 'Microsoft Yahei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
        }

        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        h3 {
            color: #666;
            margin-top: 20px;
            margin-bottom: 15px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .array-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            position: relative;
        }

        .array-item:hover {
            border-color: #4CAF50;
        }

        .array-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .array-item-title {
            font-weight: bold;
            color: #333;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn-danger {
            background-color: #f44336;
        }

        .btn-danger:hover {
            background-color: #da190b;
        }

        .btn-secondary {
            background-color: #666;
        }

        .btn-secondary:hover {
            background-color: #555;
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }

        .message {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }

        .card-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .coordinate-inputs {
            display: flex;
            gap: 10px;
        }

        .coordinate-inputs input {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>配置管理</h1>

        <div id="message" class="message" style="display: none;"></div>

        <!-- 快速操作 -->
        <div class="section">
            <h2>快速操作</h2>
            <button class="btn" onclick="saveAllConfig()">保存配置(下方编辑好后再保存)</button>
            <button class="btn btn-secondary" onclick="switchToJson()">JSON编辑</button>
        </div>

        <!-- 基本配置 -->
        <div id="basic" class="section">
            <h2>基本配置</h2>
            <div class="grid">
                <!-- 文本配置 -->
                <div class="card">
                    <div class="card-header">文本配置</div>
                    <div class="form-group">
                        <label>页面标题</label>
                        <input type="text" id="textTitle" placeholder="输入页面标题">
                    </div>
                    <div class="form-group">
                        <label>加载提示</label>
                        <input type="text" id="textLoading" placeholder="输入加载提示文本">
                    </div>
                    <div class="form-group">
                        <label>开始按钮文本</label>
                        <input type="text" id="textStart" placeholder="输入开始按钮文本">
                    </div>
                    <div class="form-group">
                        <label>祝福语</label>
                        <input type="text" id="textBirthdayWish" placeholder="输入祝福文本">
                    </div>
                    <div class="form-group">
                        <label>分享到微博按钮</label>
                        <input type="text" id="textShareWeibo" placeholder="输入分享按钮文本">
                    </div>
                    <div class="form-group">
                        <label>再看一次按钮</label>
                        <input type="text" id="textWatchAgain" placeholder="输入再看一次按钮文本">
                    </div>
                </div>

                <!-- 音频配置 -->
                <div class="card">
                    <div class="card-header">音频配置</div>
                    <div class="form-group">
                        <label>音频文件路径</label>
                        <input type="text" id="audioSrc" placeholder="输入音频文件路径">
                    </div>
                    <div class="form-group">
                        <label>音频文件备选路径</label>
                        <input type="text" id="audioFallback" placeholder="输入音频文件备选路径">
                    </div>
                </div>

                <!-- 分享配置 -->
                <div class="card">
                    <div class="card-header">分享配置</div>
                    <div class="form-group">
                        <label>分享内容</label>
                        <textarea id="shareContent" placeholder="输入分享内容"></textarea>
                    </div>
                    <div class="form-group">
                        <label>分享链接</label>
                        <input type="text" id="shareUrl" placeholder="输入分享链接">
                    </div>
                    <div class="form-group">
                        <label>分享图片</label>
                        <input type="text" id="sharePic" placeholder="输入分享图片路径">
                        <input type="file" id="sharePicUpload" accept="image/*" style="margin-top: 10px;">
                        <button class="btn btn-sm" onclick="uploadImage('sharePic')"
                            style="margin-top: 10px;">上传图片</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 地点配置 -->
        <div id="locations" class="section">
            <h2>双方基础信息</h2>
            <p>配置双方地点的信息，包括名称、地址和坐标。</p>
            <div id="locationsList" class="array-list">
                <!-- 地点项将通过JavaScript动态添加 -->
            </div>
            <!-- <button class="btn" onclick="addLocation()">添加新地点</button> -->
        </div>

        <!-- 路线信息 -->
        <div id="route" class="section">
            <h2>路线信息</h2>
            <p>点击下方按钮添加新路线信息，或点击信息项进行编辑和删除。</p>

            <div id="routeList" class="array-list">
                <!-- 路线信息项将通过JavaScript动态添加 -->
            </div>

            <button class="btn" onclick="addRoute()">添加新路线信息</button>
        </div>





        <!-- 照片管理 -->
        <div id="photos" class="section">
            <h2>照片管理</h2>
            <p>点击下方按钮添加新照片，或点击照片项进行编辑和删除。</p>

            <div id="photosList" class="array-list">
                <!-- 照片项将通过JavaScript动态添加 -->
            </div>

            <button class="btn" onclick="addPhoto()">添加新照片</button>
        </div>

        <!-- 想去的地方 -->
        <div id="wannato" class="section">
            <h2>想去的地方</h2>
            <p>点击下方按钮添加新地点，或点击地点项进行编辑和删除。</p>

            <div id="wannatoList" class="array-list">
                <!-- 地点项将通过JavaScript动态添加 -->
            </div>

            <button class="btn" onclick="addWannaTo()">添加新地点</button>
        </div>



        <!-- 高级配置 -->
        <div id="advanced" class="section">
            <h2>高级配置</h2>
            <div class="grid">
                <!-- 地理坐标配置 -->
                <div class="card">
                    <div class="card-header">地理坐标配置</div>
                    <div class="form-group">
                        <label>初始化地图中心地址</label>
                        <input type="text" id="initMpCenAddress" placeholder="输入地址（如：广西容县）">
                        <button class="btn btn-sm" onclick="geocodeCoordsAddress('initMpCen')"
                            style="margin-top: 10px;">解析坐标</button>
                    </div>
                    <div class="form-group">
                        <label>初始化地图中心坐标</label>
                        <div class="coordinate-inputs">
                            <input type="text" id="mpCenLng" placeholder="经度">
                            <input type="text" id="mpCenLat" placeholder="纬度">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>想去的地方中国中心地址</label>
                        <input type="text" id="wantToCnCenAddress" placeholder="输入地址（如：广东深圳）">
                        <button class="btn btn-sm" onclick="geocodeCoordsAddress('wantToCnCen')"
                            style="margin-top: 10px;">解析坐标</button>
                    </div>
                    <div class="form-group">
                        <label>想去的地方中国中心坐标</label>
                        <div class="coordinate-inputs">
                            <input type="text" id="cnCenLng" placeholder="经度">
                            <input type="text" id="cnCenLat" placeholder="纬度">
                        </div>
                    </div>
                </div>

                <!-- 动画配置 -->
                <div class="card">
                    <div class="card-header">动画配置</div>
                    <div class="form-group">
                        <label>缩放动画速度</label>
                        <input type="text" id="animationZoomSpeed" placeholder="输入缩放动画速度">
                    </div>
                    <div class="form-group">
                        <label>平移动画延迟</label>
                        <input type="text" id="animationPanDelay" placeholder="输入平移动画延迟">
                    </div>
                    <div class="form-group">
                        <label>信息窗口显示时间</label>
                        <input type="text" id="animationInfoWindowTimeout" placeholder="输入信息窗口显示时间">
                    </div>
                    <div class="form-group">
                        <label>标记点添加间隔</label>
                        <input type="text" id="animationMarkerInterval" placeholder="输入标记点添加间隔">
                    </div>
                </div>
            </div>
        </div>



        <!-- JSON编辑 -->
        <div id="json" class="section" style="display: none;">
            <h2>JSON编辑</h2>
            <p>您可以直接编辑下面的 JSON 配置，然后保存：</p>
            <textarea id="configJson" class="json-editor" style="width: 100%; height: 500px;"></textarea>
            <div class="actions">
                <button class="btn" onclick="saveJsonConfig()">保存 JSON 配置</button>
                <button class="btn btn-secondary" onclick="switchToBasic()">返回基本配置</button>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="./config.js"></script>
    <script type="text/javascript"
        src="http://api.map.baidu.com/api?v=2.0&ak=EXl1klVct9z0GXE7KAkPUkawwDhDN0h9"></script>
    <script type="text/javascript">
        // 当前配置
        let currentConfig = {};

        // 显示消息
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = 'message ' + type;
            messageElement.style.display = 'block';

            // 3秒后自动隐藏
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        // 切换到JSON编辑页面
        function switchToJson() {
            // 隐藏所有配置模块
            document.getElementById('basic').style.display = 'none';
            document.getElementById('photos').style.display = 'none';
            document.getElementById('wannato').style.display = 'none';
            document.getElementById('advanced').style.display = 'none';
            document.getElementById('route').style.display = 'none';
            document.getElementById('locations').style.display = 'none';


            // 显示JSON编辑模块
            document.getElementById('json').style.display = 'block';
        }

        // 切换到基本配置页面
        function switchToBasic() {
            // 显示所有配置模块
            document.getElementById('basic').style.display = 'block';
            document.getElementById('photos').style.display = 'block';
            document.getElementById('wannato').style.display = 'block';
            document.getElementById('advanced').style.display = 'block';
            document.getElementById('route').style.display = 'block';
            document.getElementById('locations').style.display = 'block';

            // 隐藏JSON编辑模块
            document.getElementById('json').style.display = 'none';
        }

        // 加载配置
        async function loadConfig() {
            try {
                // 使用ConfigManager获取配置
                if (window.ConfigManager) {
                    currentConfig = await window.ConfigManager.getConfig();
                } else {
                    showMessage('加载配置失败：配置管理器未初始化', 'error');
                    return;
                }
                console.log('xxxxxxx currentConfig', currentConfig);

                // 加载基本配置
                loadBasicConfig();

                // 加载照片配置
                loadPhotosConfig();

                // 加载想去的地方配置
                loadWannaToConfig();

                // 加载路线信息配置
                loadRouteConfig();

                // 加载地点配置
                loadLocationsConfig();

                // 加载高级配置
                loadAdvancedConfig();

                // 加载JSON配置
                loadConfigToJson();

                showMessage('配置加载成功！', 'success');
            } catch (error) {
                console.error('Error loading config:', error);
                showMessage('加载配置失败：' + error.message, 'error');
            }
        }

        // 加载基本配置
        function loadBasicConfig() {
            // 文本配置
            document.getElementById('textTitle').value = currentConfig.TEXT?.TITLE || '';
            document.getElementById('textLoading').value = currentConfig.TEXT?.LOADING || '';
            document.getElementById('textStart').value = currentConfig.TEXT?.START || '';
            document.getElementById('textBirthdayWish').value = currentConfig.TEXT?.BIRTHDAY_WISH || '';
            document.getElementById('textShareWeibo').value = currentConfig.TEXT?.SHARE_WEIBO || '';
            document.getElementById('textWatchAgain').value = currentConfig.TEXT?.WATCH_AGAIN || '';

            // 音频配置
            document.getElementById('audioSrc').value = currentConfig.AUDIO?.src || '';
            document.getElementById('audioFallback').value = currentConfig.AUDIO?.fallback || '';

            // 分享配置
            document.getElementById('shareContent').value = currentConfig.SHARE?.CONTENT || '';
            document.getElementById('shareUrl').value = currentConfig.SHARE?.URL || '';
            document.getElementById('sharePic').value = currentConfig.SHARE?.PIC || '';
        }

        // 加载照片配置
        function loadPhotosConfig() {
            const photosList = document.getElementById('photosList');
            photosList.innerHTML = '';

            if (currentConfig.PHOTOS && Array.isArray(currentConfig.PHOTOS)) {
                currentConfig.PHOTOS.forEach((photo, index) => {
                    addPhotoItem(photo, index);
                });
            }
        }

        // 加载想去的地方配置
        function loadWannaToConfig() {
            const wannatoList = document.getElementById('wannatoList');
            wannatoList.innerHTML = '';

            if (currentConfig.WANNATO && Array.isArray(currentConfig.WANNATO)) {
                currentConfig.WANNATO.forEach((place, index) => {
                    addWannaToItem(place, index);
                });
            }
        }

        // 加载高级配置
        function loadAdvancedConfig() {
            // 地理坐标配置
            document.getElementById('initMpCenAddress').value = currentConfig.COORDS?.INIT_MP_CEN_ADDRESS || '';
            document.getElementById('mpCenLng').value = currentConfig.COORDS?.INIT_MP_CEN?.lng || '';
            document.getElementById('mpCenLat').value = currentConfig.COORDS?.INIT_MP_CEN?.lat || '';
            document.getElementById('wantToCnCenAddress').value = currentConfig.COORDS?.WANT_TO_CN_CEN_ADDRESS || '';
            document.getElementById('cnCenLng').value = currentConfig.COORDS?.WANT_TO_CN_CEN?.lng || '';
            document.getElementById('cnCenLat').value = currentConfig.COORDS?.WANT_TO_CN_CEN?.lat || '';

            // 动画配置
            document.getElementById('animationZoomSpeed').value = currentConfig.ANIMATION?.ZOOM_SPEED || '';
            document.getElementById('animationPanDelay').value = currentConfig.ANIMATION?.PAN_DELAY || '';
            document.getElementById('animationInfoWindowTimeout').value = currentConfig.ANIMATION?.INFO_WINDOW_TIMEOUT || '';
            document.getElementById('animationMarkerInterval').value = currentConfig.ANIMATION?.MARKER_INTERVAL || '';
        }

        // 加载配置到JSON编辑器
        function loadConfigToJson() {
            document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 2);
        }

        // 保存所有配置
        async function saveAllConfig() {
            try {
                // 收集基本配置
                collectBasicConfig();

                // 收集照片配置
                collectPhotosConfig();

                // 收集想去的地方配置
                collectWannaToConfig();

                // 收集路线信息配置
                collectRouteConfig();

                // 收集地点配置
                collectLocationsConfig();

                // 收集高级配置
                collectAdvancedConfig();

                // 保存配置
                await saveConfig(currentConfig);
            } catch (error) {
                console.error('Error saving config:', error);
                showMessage('保存配置失败：' + error.message, 'error');
            }
        }

        // 收集基本配置
        function collectBasicConfig() {
            // 文本配置
            if (!currentConfig.TEXT) {
                currentConfig.TEXT = {};
            }
            currentConfig.TEXT.TITLE = document.getElementById('textTitle').value;
            currentConfig.TEXT.LOADING = document.getElementById('textLoading').value;
            currentConfig.TEXT.START = document.getElementById('textStart').value;
            currentConfig.TEXT.BIRTHDAY_WISH = document.getElementById('textBirthdayWish').value;
            currentConfig.TEXT.SHARE_WEIBO = document.getElementById('textShareWeibo').value;
            currentConfig.TEXT.WATCH_AGAIN = document.getElementById('textWatchAgain').value;

            // 音频配置
            if (!currentConfig.AUDIO) {
                currentConfig.AUDIO = {};
            }
            currentConfig.AUDIO.src = document.getElementById('audioSrc').value;
            currentConfig.AUDIO.fallback = document.getElementById('audioFallback').value;

            // 分享配置
            if (!currentConfig.SHARE) {
                currentConfig.SHARE = {};
            }
            currentConfig.SHARE.CONTENT = document.getElementById('shareContent').value;
            currentConfig.SHARE.URL = document.getElementById('shareUrl').value;
            currentConfig.SHARE.PIC = document.getElementById('sharePic').value;
        }

        // 收集照片配置
        function collectPhotosConfig() {
            const photos = [];
            const photoItems = document.querySelectorAll('#photosList .array-item');

            photoItems.forEach(item => {
                const title = item.querySelector('input[name="photoTitle"]').value;
                const image = item.querySelector('input[name="photoImage"]').value;
                const address = item.querySelector('input[name="photoAddress"]').value;
                const lng = parseFloat(item.querySelector('input[name="photoLng"]').value);
                const lat = parseFloat(item.querySelector('input[name="photoLat"]').value);

                if (lng && lat) {
                    photos.push({
                        title: title,
                        contentType: 'image',
                        content: image,
                        address: address,
                        point: { lng: lng, lat: lat }
                    });
                }
            });

            currentConfig.PHOTOS = photos;
        }

        // 收集想去的地方配置
        function collectWannaToConfig() {
            const places = [];
            const placeItems = document.querySelectorAll('#wannatoList .array-item');

            placeItems.forEach(item => {
                const title = item.querySelector('input[name="placeTitle"]').value;
                const content = item.querySelector('input[name="placeImage"]').value;
                const contentType = item.querySelector('input[name="placeImage"]').dataset['contentType'];
                const address = item.querySelector('input[name="placeAddress"]').value;
                const lng = parseFloat(item.querySelector('input[name="placeLng"]').value);
                const lat = parseFloat(item.querySelector('input[name="placeLat"]').value);

                if (lng && lat) {
                    places.push({
                        title: title,
                        contentType: contentType,
                        content: content,
                        address: address,
                        point: { lng: lng, lat: lat }
                    });
                }
            });

            currentConfig.WANNATO = places;
        }

        // 收集高级配置
        function collectAdvancedConfig() {
            // 地理坐标配置
            if (!currentConfig.COORDS) {
                currentConfig.COORDS = {};
            }
            currentConfig.COORDS.INIT_MP_CEN_ADDRESS = document.getElementById('initMpCenAddress').value;
            currentConfig.COORDS.INIT_MP_CEN = {
                lng: parseFloat(document.getElementById('mpCenLng').value),
                lat: parseFloat(document.getElementById('mpCenLat').value)
            };
            currentConfig.COORDS.WANT_TO_CN_CEN_ADDRESS = document.getElementById('wantToCnCenAddress').value;
            currentConfig.COORDS.WANT_TO_CN_CEN = {
                lng: parseFloat(document.getElementById('cnCenLng').value),
                lat: parseFloat(document.getElementById('cnCenLat').value)
            };

            // 动画配置
            if (!currentConfig.ANIMATION) {
                currentConfig.ANIMATION = {};
            }
            currentConfig.ANIMATION.ZOOM_SPEED = parseInt(document.getElementById('animationZoomSpeed').value);
            currentConfig.ANIMATION.PAN_DELAY = parseInt(document.getElementById('animationPanDelay').value);
            currentConfig.ANIMATION.INFO_WINDOW_TIMEOUT = parseInt(document.getElementById('animationInfoWindowTimeout').value);
            currentConfig.ANIMATION.MARKER_INTERVAL = parseInt(document.getElementById('animationMarkerInterval').value);
        }

        // 保存配置
        async function saveConfig(config) {
            console.log('saveConfig', config);
            try {
                // 使用ConfigManager保存配置
                if (window.ConfigManager) {
                    const success = await window.ConfigManager.saveConfig(config);
                    if (success) {
                        showMessage('配置保存成功！', 'success');
                        //刷新页面
                        window.location.reload();
                    } else {
                        throw new Error('保存失败');
                    }
                } else {
                    throw new Error('ConfigManager不可用');
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showMessage('保存配置失败：' + error.message, 'error');
            }
        }

        // 上传图片
        async function uploadImage(inputId) {
            const fileInput = document.getElementById(inputId + 'Upload');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('请选择要上传的图片！', 'error');
                return;
            }

            try {
                showMessage('正在上传图片...', 'info');

                if (window.ConfigManager && window.ConfigManager.uploadImage) {
                    const result = await window.ConfigManager.uploadImage(file);
                    if (result.success) {
                        document.getElementById(inputId).value = result.url;
                        showMessage('图片上传成功！', 'success');
                    } else {
                        showMessage('图片上传失败：' + result.message, 'error');
                    }
                } else {
                    showMessage('上传功能不可用，请检查配置', 'error');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                showMessage('上传失败：' + error.message, 'error');
            }
        }

        // 上传照片模块的图片
        async function uploadPhotoImage(button) {
            const item = button.closest('.array-item');
            const fileInput = item.querySelector('input[name="photoImageUpload"]');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('请选择要上传的图片！', 'error');
                return;
            }

            try {
                showMessage('正在上传图片...', 'info');

                if (window.ConfigManager && window.ConfigManager.uploadImage) {
                    const result = await window.ConfigManager.uploadImage(file);
                    if (result.success) {
                        // 设置下 data-content-type 值为image
                        item.querySelector('input[name="photoImage"]').dataset['contentType'] = 'image';
                        item.querySelector('input[name="photoImage"]').value = result.url;
                        showMessage('图片上传成功！', 'success');
                    } else {
                        showMessage('图片上传失败：' + result.message, 'error');
                    }
                } else {
                    showMessage('上传功能不可用，请检查配置', 'error');
                }
            } catch (error) {
                console.error('Error uploading photo image:', error);
                showMessage('上传失败：' + error.message, 'error');
            }
        }

        // 上传想去的地方模块的图片
        async function uploadPlaceImage(button) {
            const item = button.closest('.array-item');
            const fileInput = item.querySelector('input[name="placeImageUpload"]');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('请选择要上传的图片！', 'error');
                return;
            }

            try {
                showMessage('正在上传图片...', 'info');

                if (window.ConfigManager && window.ConfigManager.uploadImage) {
                    const result = await window.ConfigManager.uploadImage(file);
                    if (result.success) {
                        // 设置下 data-content-type 值为image
                        item.querySelector('input[name="placeImage"]').dataset['contentType'] = 'image';
                        item.querySelector('input[name="placeImage"]').value = result.url;
                        showMessage('图片上传成功！', 'success');
                    } else {
                        showMessage('图片上传失败：' + result.message, 'error');
                    }
                } else {
                    showMessage('上传功能不可用，请检查配置', 'error');
                }
            } catch (error) {
                console.error('Error uploading place image:', error);
                showMessage('上传失败：' + error.message, 'error');
            }
        }

        // 保存JSON配置
        async function saveJsonConfig() {
            const configJson = document.getElementById('configJson').value;
            // 校验下是否符合json
            if (!configJson.trim()) {
                showMessage('请输入JSON配置！', 'error');
                return;
            }

            try {
                const config = JSON.parse(configJson);
                await saveConfig(config);
            } catch (error) {
                showMessage('JSON格式错误：' + error.message, 'error');
            }
        }



        // 添加照片项
        function addPhotoItem(photo = {}, index = -1) {
            const photosList = document.getElementById('photosList');
            const itemId = index >= 0 ? index : Date.now();

            const item = document.createElement('div');
            item.className = 'array-item';
            item.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">照片 ${index >= 0 ? index + 1 : '新'}</div>
                    <div>
                        <button class="btn btn-sm" onclick="editPhoto(${itemId})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePhoto(${itemId})">删除</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" name="photoTitle" value="${photo.title || ''}" placeholder="输入照片标题">
                </div>
                <div class="form-group">
                    <label>图片路径</label>
                    <input type="text" name="photoImage" value="${photo.content || ''}" placeholder="输入图片路径">
                    <input type="file" name="photoImageUpload" accept="image/*" style="margin-top: 10px;">
                    <button class="btn btn-sm" onclick="uploadPhotoImage(this)" style="margin-top: 10px;">上传图片</button>
                </div>
                <div class="form-group">
                    <label>地址</label>
                    <input type="text" name="photoAddress" value="${photo.address || ''}" placeholder="输入地址（如：广东省广州市天河区）">
                    <button class="btn btn-sm" onclick="geocodeAddress(this, 'photo')" style="margin-top: 10px;">解析坐标</button>
                </div>
                <div class="form-group">
                    <label>坐标</label>
                    <div class="coordinate-inputs">
                        <input type="text" name="photoLng" value="${photo.point?.lng || ''}" placeholder="经度">
                        <input type="text" name="photoLat" value="${photo.point?.lat || ''}" placeholder="纬度">
                    </div>
                </div>
                ${photo.contentType === 'image' ? `<img class="photo-preview" src="${photo.content}" alt="预览">` : ''}
            `;

            photosList.appendChild(item);
        }

        // 添加新照片
        function addPhoto() {
            addPhotoItem();
        }

        // 编辑照片
        function editPhoto(index) {
            // 这里可以实现更复杂的编辑逻辑，比如弹出模态框
            showMessage('点击照片项中的输入框即可编辑', 'info');
        }

        // 删除照片
        function deletePhoto(index) {
            const photosList = document.getElementById('photosList');
            const items = photosList.querySelectorAll('.array-item');
            if (items[index]) {
                items[index].remove();
                showMessage('照片删除成功！', 'success');
            }
        }

        // 添加想去的地方项
        function addWannaToItem(place = {}, index = -1) {
            const wannatoList = document.getElementById('wannatoList');
            const itemId = index >= 0 ? index : Date.now();

            const item = document.createElement('div');
            item.className = 'array-item';
            item.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">地点 ${index >= 0 ? index + 1 : '新'}</div>
                    <div>
                        <button class="btn btn-sm" onclick="editWannaTo(${itemId})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWannaTo(${itemId})">删除</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" name="placeTitle" value="${place.title || ''}" placeholder="输入地点">
                </div>
                <div class="form-group">
                    <label>图片路径</label>
                    <input type="text" name="placeImage" data-content-type="${place.contentType || 'text'}" value="${place.content || ''}" placeholder="输入图片路径">
                    <input type="file" name="placeImageUpload" accept="image/*" style="margin-top: 10px;">
                    <button class="btn btn-sm" onclick="uploadPlaceImage(this)" style="margin-top: 10px;">上传图片</button>
                </div>
                <div class="form-group">
                    <label>地址</label>
                    <input type="text" name="placeAddress" value="${place.address || ''}" placeholder="输入地址（如：广东省广州市天河区）">
                    <button class="btn btn-sm" onclick="geocodeAddress(this, 'place')" style="margin-top: 10px;">解析坐标</button>
                </div>
                <div class="form-group">
                    <label>坐标</label>
                    <div class="coordinate-inputs">
                        <input type="text" name="placeLng" value="${place.point?.lng || ''}" placeholder="经度">
                        <input type="text" name="placeLat" value="${place.point?.lat || ''}" placeholder="纬度">
                    </div>
                </div>
                ${place.contentType === 'image' ? `<img class="photo-preview" src="${place.content}" alt="预览">` : ''}
            `;

            wannatoList.appendChild(item);
        }

        // 添加新地点
        function addWannaTo() {
            addWannaToItem();
        }

        // 编辑地点
        function editWannaTo(index) {
            // 这里可以实现更复杂的编辑逻辑，比如弹出模态框
            showMessage('点击地点项中的输入框即可编辑', 'info');
        }

        // 删除地点
        function deleteWannaTo(index) {
            const wannatoList = document.getElementById('wannatoList');
            const items = wannatoList.querySelectorAll('.array-item');
            if (items[index]) {
                items[index].remove();
                showMessage('地点删除成功！', 'success');
            }
        }

        // 加载路线信息配置
        function loadRouteConfig() {
            const routeList = document.getElementById('routeList');
            routeList.innerHTML = '';

            if (currentConfig.ROUTE_INFO && Array.isArray(currentConfig.ROUTE_INFO)) {
                currentConfig.ROUTE_INFO.forEach((route, index) => {
                    addRouteItem(route, index);
                });
            }
        }

        // 加载地点配置
        function loadLocationsConfig() {
            const locationsList = document.getElementById('locationsList');
            locationsList.innerHTML = '';

            if (currentConfig.LOCATIONS) {
                Object.keys(currentConfig.LOCATIONS).forEach((key, index) => {
                    addLocationItem(key, currentConfig.LOCATIONS[key], index);
                });
            }
        }

        // 收集路线信息配置
        function collectRouteConfig() {
            const routeList = document.getElementById('routeList');
            const routeItems = routeList.querySelectorAll('.array-item');
            const routes = [];

            routeItems.forEach(item => {
                const title = item.querySelector('input[name="routeTitle"]').value;
                const content = item.querySelector('input[name="routeContent"]').value;
                const contentType = item.querySelector('input[name="routeContent"]').dataset['contentType'] || 'text';
                const address = item.querySelector('input[name="routeAddress"]').value;
                const lng = parseFloat(item.querySelector('input[name="routeLng"]').value);
                const lat = parseFloat(item.querySelector('input[name="routeLat"]').value);

                if (lng && lat) {
                    routes.push({
                        title: title,
                        contentType: contentType,
                        content: content,
                        address: address,
                        point: { lng: lng, lat: lat }
                    });
                }
            });

            currentConfig.ROUTE_INFO = routes;
        }

        // 收集地点配置
        function collectLocationsConfig() {
            const locationsList = document.getElementById('locationsList');
            const locationItems = locationsList.querySelectorAll('.array-item');
            const locations = {};

            locationItems.forEach(item => {
                const key = item.querySelector('input[name="locationKey"]').value;
                const name = item.querySelector('input[name="locationName"]').value;
                const address = item.querySelector('input[name="locationAddress"]').value;
                const lng = parseFloat(item.querySelector('input[name="locationLng"]').value);
                const lat = parseFloat(item.querySelector('input[name="locationLat"]').value);

                if (key && lng && lat) {
                    locations[key] = {
                        desc: item.querySelector('label').textContent || '',
                        name: name,
                        address: address,
                        coords: { lng: lng, lat: lat }
                    };
                }
            });

            currentConfig.LOCATIONS = locations;
        }

        // 添加路线信息项
        function addRouteItem(route = {}, index = -1) {
            const routeList = document.getElementById('routeList');
            const itemId = index >= 0 ? index : Date.now();

            const item = document.createElement('div');
            item.className = 'array-item';
            item.innerHTML = `
                <div class="array-item-header">
                    <div class="array-item-title">路线信息 ${index >= 0 ? index + 1 : '新'}</div>
                    <div>
                        <button class="btn btn-sm" onclick="editRoute(${itemId})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRoute(${itemId})">删除</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>标题</label>
                    <input type="text" name="routeTitle" value="${route.title || ''}" placeholder="输入路线标题">
                </div>
                <div class="form-group">
                    <label>内容</label>
                    <input type="text" name="routeContent" data-content-type="${route.contentType || 'text'}" value="${route.content || ''}" placeholder="输入路线内容">
                    <input type="file" name="routeContentUpload" accept="image/*" style="margin-top: 10px;">
                    <button class="btn btn-sm" onclick="uploadRouteImage(this)" style="margin-top: 10px;">上传图片</button>
                </div>
                <div class="form-group">
                    <label>地址</label>
                    <input type="text" name="routeAddress" value="${route.address || ''}" placeholder="输入地址（如：广东省广州市天河区）">
                    <button class="btn btn-sm" onclick="geocodeAddress(this, 'route')" style="margin-top: 10px;">解析坐标</button>
                </div>
                <div class="form-group">
                    <label>坐标</label>
                    <div class="coordinate-inputs">
                        <input type="text" name="routeLng" value="${route.point?.lng || ''}" placeholder="经度">
                        <input type="text" name="routeLat" value="${route.point?.lat || ''}" placeholder="纬度">
                    </div>
                </div>
                ${route.contentType === 'image' ? `<img class="photo-preview" src="${route.content}" alt="预览">` : ''}
            `;

            routeList.appendChild(item);
        }

        // 添加新路线信息
        function addRoute() {
            addRouteItem();
        }

        // 编辑路线信息
        function editRoute(index) {
            showMessage('点击路线信息项中的输入框即可编辑', 'info');
        }

        // 删除路线信息
        function deleteRoute(index) {
            const routeList = document.getElementById('routeList');
            const items = routeList.querySelectorAll('.array-item');
            if (items[index]) {
                items[index].remove();
                showMessage('路线信息删除成功！', 'success');
            }
        }

        // 添加地点项
        function addLocationItem(key = '', location = {}, index = -1) {
            const locationsList = document.getElementById('locationsList');
            const itemId = index >= 0 ? index : Date.now();

            const item = document.createElement('div');
            item.className = 'array-item';
            item.innerHTML = `
                <div class="form-group">
                    <label>${location.desc || ''}</label>
                    <input type="text" style="display: none;" name="locationKey" value="${key || ''}" ">
                </div>
                <div class="form-group">
                    <label>地点名称</label>
                    <input type="text" name="locationName" value="${location.name || ''}" placeholder="输入地点名称（如：嘉应学院）">
                </div>
                <div class="form-group">
                    <label>地址</label>
                    <input type="text" name="locationAddress" value="${location.address || ''}" placeholder="输入地址（如：广西容县）">
                    <button class="btn btn-sm" onclick="geocodeAddress(this, 'location')" style="margin-top: 10px;">解析坐标</button>
                </div>
                <div class="form-group">
                    <label>坐标</label>
                    <div class="coordinate-inputs">
                        <input type="text" name="locationLng" value="${location.coords?.lng || ''}" placeholder="经度">
                        <input type="text" name="locationLat" value="${location.coords?.lat || ''}" placeholder="纬度">
                    </div>
                </div>
            `;

            locationsList.appendChild(item);
        }

        // // 添加新地点
        // function addLocation() {
        //     addLocationItem();
        // }

        // 编辑地点
        function editLocation(index) {
            showMessage('点击地点项中的输入框即可编辑', 'info');
        }

        // 删除地点
        function deleteLocation(index) {
            const locationsList = document.getElementById('locationsList');
            const items = locationsList.querySelectorAll('.array-item');
            if (items[index]) {
                items[index].remove();
                showMessage('地点删除成功！', 'success');
            }
        }

        // 上传路线信息模块的图片
        async function uploadRouteImage(button) {
            const item = button.closest('.array-item');
            const fileInput = item.querySelector('input[name="routeContentUpload"]');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('请选择要上传的图片！', 'error');
                return;
            }

            try {
                showMessage('正在上传图片...', 'info');

                if (window.ConfigManager && window.ConfigManager.uploadImage) {
                    const result = await window.ConfigManager.uploadImage(file);
                    if (result.success) {
                        // 设置下 data-content-type 值为image
                        item.querySelector('input[name="routeContent"]').dataset['contentType'] = 'image';
                        item.querySelector('input[name="routeContent"]').value = result.url;
                        showMessage('图片上传成功！', 'success');
                    } else {
                        showMessage('图片上传失败：' + result.message, 'error');
                    }
                } else {
                    showMessage('上传功能不可用，请检查配置', 'error');
                }
            } catch (error) {
                console.error('Error uploading route image:', error);
                showMessage('上传失败：' + error.message, 'error');
            }
        }

        // 地址解析函数
        function geocodeAddress(button, type) {
            const item = button.closest('.array-item');
            const addressInput = item.querySelector(`input[name="${type}Address"]`);
            const lngInput = item.querySelector(`input[name="${type}Lng"]`);
            const latInput = item.querySelector(`input[name="${type}Lat"]`);

            const address = addressInput.value.trim();

            if (!address) {
                showMessage('请输入地址！', 'error');
                return;
            }

            if (typeof BMap === 'undefined') {
                showMessage('百度地图API未加载，请检查网络连接！', 'error');
                return;
            }

            try {
                showMessage('正在解析地址...', 'info');

                const myGeo = new BMap.Geocoder();
                myGeo.getPoint(address, function (point) {
                    console.log("地址解析结果: ", point);
                    if (point) {
                        lngInput.value = point.lng;
                        latInput.value = point.lat;
                        showMessage('地址解析成功！', 'success');
                    } else {
                        alert('无法解析地址，请检查地址是否正确！');
                        showMessage('无法解析地址，请检查地址是否正确！', 'error');
                    }
                }, '');
            } catch (error) {
                console.error('Error geocoding address:', error);
                showMessage('地址解析失败：' + error.message, 'error');
            }
        }

        // 解析地理坐标配置中的地址
        function geocodeCoordsAddress(type) {
            let addressInput, lngInput, latInput;

            if (type === 'initMpCen') {
                addressInput = document.getElementById('initMpCenAddress');
                lngInput = document.getElementById('mpCenLng');
                latInput = document.getElementById('mpCenLat');
            } else if (type === 'wantToCnCen') {
                addressInput = document.getElementById('wantToCnCenAddress');
                lngInput = document.getElementById('cnCenLng');
                latInput = document.getElementById('cnCenLat');
            }

            const address = addressInput.value.trim();

            if (!address) {
                showMessage('请输入地址！', 'error');
                return;
            }

            if (typeof BMap === 'undefined') {
                showMessage('百度地图API未加载，请检查网络连接！', 'error');
                return;
            }

            try {
                showMessage('正在解析地址...', 'info');

                const myGeo = new BMap.Geocoder();
                myGeo.getPoint(address, function (point) {
                    console.log("地址解析结果: ", point);
                    if (point) {
                        lngInput.value = point.lng;
                        latInput.value = point.lat;
                        showMessage('地址解析成功！', 'success');
                    } else {
                        showMessage('无法解析地址，请检查地址是否正确！', 'error');
                    }
                });
            } catch (error) {
                console.error('Error geocoding address:', error);
                showMessage('地址解析失败：' + error.message, 'error');
            }
        }

        // 页面加载时初始化
        window.onload = async function () {
            await loadConfig();
        };
    </script>
</body>

</html>